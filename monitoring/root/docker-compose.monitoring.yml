services:
  prometheus:
    image: prom/prometheus
    container_name: couponpop-prometheus
    restart: unless-stopped
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=7d
      - --web.enable-lifecycle
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml # (1) 설정 파일
      - /data/prometheus:/prometheus                   # (2) 데이터 저장 (EBS 볼륨)
    ports:
      - "${PROMETHEUS_PORT}:9090"
    depends_on:
      - mysqld_exporter

  grafana:
    image: grafana/grafana
    container_name: couponpop-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - /data/grafana:/var/lib/grafana                  # (1) 데이터 저장 (EBS 볼륨)
      - ./grafana/provisioning:/etc/grafana/provisioning # (2) 설정 파일
      - ./grafana/dashboards:/var/lib/grafana/dashboards # (3) 대시보드 파일
    ports:
      - "${GRAFANA_PORT}:3000"
    depends_on:
      - prometheus

  mysqld_exporter:
    image: prom/mysqld-exporter
    container_name: couponpop-mysqld-exporter
    restart: unless-stopped
    command:
      - --mysqld.username=${MYSQLD_EXPORTER_USERNAME}
      - --mysqld.password=${MYSQLD_EXPORTER_PASSWORD}
      - --mysqld.address=${DB_HOST}:${DB_PORT}
      # 원하는 수집 항목 유지
      - --collect.global_status
      - --collect.engine_innodb_status
      - --collect.info_schema.userstats
      - --collect.perf_schema.tableiowaits
      - --collect.perf_schema.file_events
    # environment 섹션은 command에서 이미 모두 사용하므로, 이 경우 불필요하여 제거합니다.
    ports:
      - "${MYSQLD_EXPORTER_PORT}:9104"

# (중요) Docker 명명 볼륨 정의를 제거합니다.
# volumes:
#   prometheus-data:
#   grafana-data: