services:
  jenkins:
    #    image: jenkins/jenkins:lts-jdk17 # LTS 버전 (장기 지원)
    build:
      context: . # 현재 디렉토리
      dockerfile: Dockerfile.jenkins # custom한 Dockerfile 사용
    container_name: jenkins
    restart: unless-stopped # 컨테이너 재시작 정책
    privileged: true # Docker in Docker (컨테이너 내에서 Docker 명령 실행)
    user: root # 컨테이너 내에서 root 권한으로 실행 (일부 플러그인 필요)
    ports:
      - "8080:8080"
    volumes:
      # ASG의 EBS 마운트 경로(/data)를 사용
      - /data/jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock # Docker 데몬 소켓 마운트
      - /usr/bin/docker:/usr/bin/docker # Docker 실행 파일 마운트
    environment:
      - JAVA_OPTS=-Xms512m -Xmx1024m -Duser.timezone=Asia/Seoul
    networks:
      - devops-net

  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      # 내부 서비스 이름 'postgres' 사용
      - SONARQUBE_JDBC_URL=jdbc:postgresql://postgres:5432/sonarqube
      - SONARQUBE_JDBC_USERNAME=sonar
      - SONARQUBE_JDBC_PASSWORD=sonar_password
      - SONAR_JVM_OPTS=-Duser.timezone=Asia/Seoul
    volumes:
      # ASG의 EBS 마운트 경로(/data)를 사용
      - /data/sonarqube/data:/opt/sonarqube/data
      - /data/sonarqube/extensions:/opt/sonarqube/extensions
      - /data/sonarqube/logs:/opt/sonarqube/logs
    depends_on:
      - postgres
    networks:
      - devops-net

  postgres:
    image: postgres:13
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=sonarqube
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar_password
      - TZ=Asia/Seoul
    volumes:
      # ASG의 EBS 마운트 경로(/data)를 사용
      - /data/postgres/data:/var/lib/postgresql/data
    networks:
      - devops-net

# Docker Named Volumes는 호스트의 Bind Mount로 대체되었으므로 삭제

networks:
  devops-net:
    driver: bridge