# Logstash CloudWatch Input Configuration (logstash.conf)

# Logstash가 CloudWatch Input 플러그인을 설치하도록 startup 명령에 추가해야 합니다.
  # Logstash Dockerfile이 없다면, docker-compose command나 custom Dockerfile에서 처리해야 합니다.

  input {
  cloudwatch {
  # Fargate Task가 로그를 보내는 로그 그룹 이름 -> store-service만 설정
  log_group_name_prefix => "/ecs/couponpop-store-service-task-definition"
  region => "ap-northeast-2"
  # CloudWatch Logs 스트림을 읽기 위한 권한은 Logstash가 실행되는 EC2의 IAM 역할에 있어야 합니다.
  use_actual_time => true
  start_position => "end" # Logstash 시작 시 최신 로그부터 읽기 시작
  interval => 30 # 30초마다 CloudWatch Logs에서 새 로그를 폴링
  
  # [!!] Logstash가 CloudWatch API를 호출할 수 있도록 IAM Role 설정 필요
}
}

  filter {
  # ECS 로그 필터링 및 변환 (기존 Grok 필터 유지 가능)
  grok {
  match => { "message" => [
  "^%{TIMESTAMP_ISO8601:log_timestamp}\s+%{LOGLEVEL:level}\s+%{NUMBER:pid}\s+---\s+\[%{DATA:service_name}\]\s+\[%{DATA:thread_name}\]\s+%{JAVACLASS:logger_name}\s+:\s+%{GREEDYDATA:log_message}"
  ]}
  }

  # ... (기존 date, mutate 필터 유지) ...
}

  output {
  elasticsearch {
  hosts => ["http://elastic:9200"]
  index => "logstash-%{+YYYY.MM.dd}"
  # ...
  }
  # ...
}